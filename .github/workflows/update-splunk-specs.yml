name: Update Splunk Spec Files

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering
  push:
    branches:
      - ws-auto-populate
      - main
      - master

jobs:
  update-specs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # fetch-depth: 0

      - name: Checkout master branch
        run: |
          git fetch origin master
          git checkout master
          
      - name: Get Splunk version and build
        id: get_version
        run: |
          wget -O splunkDownload.html 'https://www.splunk.com/en_us/download/splunk-enterprise.html' -q
          
          version=$(cat splunkDownload.html | grep -oE "data-link=\"https://.*data-md5" | head -1 | grep -oE "splunk-.*\"" | sed "s/splunk-//g" | sed "s/-.*//g")
          build=$(cat splunkDownload.html | grep -oE "data-link=\"https://.*data-md5" | head -1 | grep -oE "splunk-.*\"" | grep -oE "[[:digit:]]-\w+-" | sed 's/^[[:digit:]]-//g' | sed 's/-//g')
          
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "build=$build" >> $GITHUB_OUTPUT
          echo "Splunk version: $version"
          echo "Splunk build: $build"

      - name: Download Splunk
        run: |
          version="${{ steps.get_version.outputs.version }}"
          build="${{ steps.get_version.outputs.build }}"
          file_pattern="linux-amd64"
          
          wget -O splunk-$version-$build-$file_pattern.tgz "https://download.splunk.com/products/splunk/releases/$version/linux/splunk-$version-$build-$file_pattern.tgz"
          echo "Downloaded: splunk-$version-$build-$file_pattern.tgz"

      - name: Extract Splunk
        run: |
          version="${{ steps.get_version.outputs.version }}"
          build="${{ steps.get_version.outputs.build }}"
          file_pattern="linux-amd64"
          
          mkdir -p /tmp/splunk-extract
          tar -xzf splunk-$version-$build-$file_pattern.tgz -C /tmp/splunk-extract
          echo "Extracted to /tmp/splunk-extract"

      - name: Copy .conf files to repo root
        run: |
          if [ -d "/tmp/splunk-extract/splunk/etc/system/default" ]; then
            cp /tmp/splunk-extract/splunk/etc/system/default/*.conf .
            echo "Copied .conf files to repo root"
          else
            echo "ERROR: default directory not found at /tmp/splunk-extract/splunk/etc/system/default"
            exit 1
          fi

      - name: Copy .spec files to repo root
        run: |
          if [ -d "/tmp/splunk-extract/splunk/etc/system/README" ]; then
            cp /tmp/splunk-extract/splunk/etc/system/README/*.spec .
            echo "Copied .spec files to repo root"
          else
            echo "ERROR: README directory not found at /tmp/splunk-extract/splunk/etc/system/README"
            exit 1
          fi

      - name: Clean up temporary files
        run: |
          version="${{ steps.get_version.outputs.version }}"
          build="${{ steps.get_version.outputs.build }}"
          file_pattern="linux-amd64"
          
          # Remove temporary download files
          rm -f splunkDownload.html
          rm -f splunk-$version-$build-$file_pattern.tgz
          echo "Cleaned up temporary files"

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Check for changes
        id: check_changes
        run: |
          # Only check for changes in .conf and .spec files
          changed_files=$(git status --porcelain | grep -E '\.(conf|spec)$' || true)
          if [ -n "$changed_files" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in .conf or .spec files"
            echo "$changed_files"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in .conf or .spec files"
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update Splunk spec files from version ${{ steps.get_version.outputs.version }} build ${{ steps.get_version.outputs.build }}"
          base: master
          branch: auto-${{ steps.get_version.outputs.version }}-${{ steps.get_version.outputs.build }}
          branch-suffix: random
          title: "Update Splunk spec files from version ${{ steps.get_version.outputs.version }} build ${{ steps.get_version.outputs.build }}"
          body: |
            This PR was automatically created to update Splunk spec files from the latest Splunk Enterprise release.
            
            **Version:** ${{ steps.get_version.outputs.version }}
            **Build:** ${{ steps.get_version.outputs.build }}
            
            Please review the changes and merge if appropriate.
          delete-branch: true

